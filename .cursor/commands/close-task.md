# close-task Command - Финализация задачи

Финализирует завершённую задачу: создаёт запись в `memory-bank/completed-tasks/`, удаляет из `memory-bank/backlog.md`, очищает Memory Bank для следующей задачи.

## Когда использовать

Запускается пользователем **явно** после всех фаз задачи (BUILD, REFLECT, ARCHIVE — в зависимости от уровня). Ни одна другая команда не выполняет финализацию автоматически.

**Отложенный вызов:** Если задача уже отмечена завершённой в другой команде (например, при ARCHIVE задача перенесена в Last Completed Task, Current Task очищен), но `/close-task` не выполнялся — команда всё равно создаст completed-запись, удалит задачу из backlog и обновит ссылки. Источником данных будет секция "Last Completed Task".

## Зависимости

Читает:

- `memory-bank/tasks.md` — task_id, название, даты, описание, уровень сложности
- `memory-bank/backlog.md` — исходное описание задачи (если задача оттуда)
- `memory-bank/completed-tasks/_template.md` — шаблон записи

Ищет артефакты по task_id:

- `memory-bank/archive/` — файл `archive-[task_id].md` или `*[task_id]*.md`
- `memory-bank/reflection/` — файл `reflection-[task_id].md`

Создаёт:

- `memory-bank/completed-tasks/YYYY/MM/[task_id]_YYYY-MM-DD.md`

Обновляет:

- `memory-bank/backlog.md` — удалить задачу из активных (если задача была в backlog)
- `memory-bank/tasks.md` — очистить и подготовить к следующей задаче
- `memory-bank/activeContext.md` — сброс для следующей задачи
- `memory-bank/progress.md` — зафиксировать завершение задачи

## Алгоритм

1. **Прочитать `memory-bank/tasks.md`**
   - **Приоритет 1:** Извлечь task_id из секции "Current Task" (если там есть задача)
   - **Приоритет 2:** Если Current Task пуст или содержит только плейсхолдер — извлечь task_id из секции "Last Completed Task"
   - Если task*id найден (в Current или Last Completed) — проверить, существует ли уже `memory-bank/completed-tasks/\*\*/[task_id]*\*.md`
     - Если completed-запись **есть** — сообщить "Задача [task_id] уже финализирована" и завершить
     - Если completed-записи **нет** — продолжить алгоритм (источник данных: Current Task или Last Completed Task)
   - Если task_id не найден ни в одной секции — сообщить "Нет активной задачи для финализации" и завершить
   - Извлечь: task_id, название, дату создания, дату завершения (текущая дата если не указана), уровень сложности, тип задачи

2. **Найти артефакты по task_id**
   - Искать `memory-bank/archive/archive-[task_id].md` и `memory-bank/archive/*[task_id]*.md`
   - Искать `memory-bank/reflection/reflection-[task_id].md`
   - Запомнить относительные пути найденных файлов (от корня `memory-bank/`)

3. **Собрать описание задачи**
   - **## Задание** — источник по приоритету:
     - Если задача из backlog — взять исходное описание из `memory-bank/backlog.md` (как было при постановке)
     - Иначе — попытаться собрать из `tasks.md`, рефлексии, архива
     - Если не удалось выяснить задание — написать явно: «Задание не удалось восстановить из доступных источников»
   - **## Изменения в задании** — только при изменении задания в процессе; описать отличия от исходного (что изменилось и почему)
   - **## Результат** — ключевые итоги из `tasks.md` (раздел «Результат» или итоги из чеклиста)

   **Структура секций completed-записи:**
   - `## Задание` — всегда; источник: backlog → tasks/рефлексия/архив → явная пометка при неудаче
   - `## Изменения в задании` — только при изменении задания; список отличий от исходного
   - `## Результат` — всегда; итоги выполнения

4. **Определить путь файла**
   - YYYY/MM — по дате **создания** задачи
   - Имя файла: `[task_id]_YYYY-MM-DD.md` — дата **завершения**
   - Создать подкаталоги YYYY/MM если не существуют

5. **Показать план и запросить подтверждение**
   - Показать: путь создаваемого файла, содержимое записи, что будет удалено/очищено
   - Дождаться явного подтверждения пользователя

6. **После подтверждения — создать completed-запись и обновить backlog:**
   - Создать файл `memory-bank/completed-tasks/YYYY/MM/[task_id]_YYYY-MM-DD.md` по шаблону `_template.md`
   - Заполнить секцию **## Ссылки** в completed-записи: пути к архиву и рефлексии (из шага 2), ветка и коммит (если доступны)
   - Если задача была в backlog — удалить её из `memory-bank/backlog.md` (из раздела активных задач)

7. **Подготовить Memory Bank к следующей задаче:**

   **КРИТИЧНО:** Этот шаг сигнализирует, что текущая задача полностью завершена. AI обязан привести Memory Bank в состояние готовности к новой задаче.

   **Определить режим:** задача взята из "Current Task" (режим A) или из "Last Completed Task" (режим B).

   **Режим A** — задача была в Current Task:
   - **`memory-bank/tasks.md`:**
     - Перенести текущую задачу из "Current Task" в "Last Completed Task" (краткая запись: task_id, название, дата, статус COMPLETED, ссылка на completed-запись)
     - Секцию "Current Task" очистить: оставить только заголовок `## Current Task` и плейсхолдер "Нет активной задачи. Запустить `/van [описание задачи]` для начала новой задачи."; удалить все подсекции уровня `###` и выше
     - Удалить все чеклисты, планы, файлы для изменения текущей задачи

   **Режим B** — задача была в Last Completed Task (Current Task уже пуст):
   - **`memory-bank/tasks.md`:**
     - Обновить секцию "Last Completed Task": добавить ссылку на completed-запись в формате `**Completed:** [путь]`, если её ещё нет
     - Секцию "Current Task" не трогать (уже очищена)
     - Удалять чеклисты не требуется (их нет)

   **Общее для обоих режимов:**
   - **`memory-bank/activeContext.md`:**
     - Секцию "Current Focus" установить в "Нет активной задачи. Запустить `/van` для инициализации."
     - Секцию "Current Mode" установить в "IDLE — ожидание новой задачи"
     - Секцию "Next Steps" установить в "Запустить `/van [описание задачи]` для начала новой задачи"
     - Удалить из "Next Steps" упоминание `/close-task` для текущей задачи
     - Секцию "Context for AI" — очистить или обновить только общую информацию о проекте (стек, структура)

   - **`memory-bank/progress.md`:**
     - Добавить запись о завершённой задаче: `## [Дата]: [task_id] — ЗАВЕРШЕНО` с кратким итогом и ссылкой на completed-запись (или обновить существующую запись, добавив ссылку на completed-запись)
     - Оставлять только одну последнюю завершённую задачу; старые записи о завершённых задачах удалить

8. **Верификация**
   - Проверить что completed-файл создан по правильному пути
   - Если задача была в backlog — проверить что она удалена
   - Проверить что tasks.md готов к новой задаче (Current Task очищен или плейсхолдер; Last Completed содержит ссылку на completed-запись)
   - Проверить что activeContext.md указывает на ожидание `/van`
   - Вывести итог: путь к созданному файлу, статус всех операций, сообщение "Memory Bank готов к следующей задаче. Запустите /van для начала."

## Интеграция с workflow

При инициализации задачи командой `/van` в чеклист `memory-bank/tasks.md` обязательно добавляется финальный пункт:

```
- [ ] CLOSE: Финализировать задачу командой /close-task
```

Этот пункт также упоминается в `memory-bank/activeContext.md` → "Next Steps" и в `memory-bank/progress.md`.

## Usage

Пользователь вводит `/close-task` после завершения всех фаз задачи.

## Пример

```
Пользователь: /close-task

Ассистент: "Финализация задачи context-api-todo-001:

Будет создано:
- memory-bank/completed-tasks/2026/01/context-api-todo-001_2026-02-02.md

Найдены артефакты:
- Архив: memory-bank/archive/archive-context-api-todo-001.md
- Рефлексия: memory-bank/reflection/reflection-context-api-todo-001.md

Будет обновлено:
- memory-bank/backlog.md — задача удалена из активных (если была в backlog)
- memory-bank/tasks.md — очищен, готов к новой задаче
- memory-bank/activeContext.md — сброшен в IDLE
- memory-bank/progress.md — добавлена запись о завершении

Выполнить?"
```
