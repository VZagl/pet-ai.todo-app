# close-task Command - Финализация задачи

Финализирует завершённую задачу: создаёт запись в `memory-bank/completed-tasks/`, удаляет из `memory-bank/backlog.md`, очищает Memory Bank для следующей задачи.

## Когда использовать

Запускается пользователем **явно** после всех фаз задачи (BUILD, REFLECT, ARCHIVE — в зависимости от уровня). Ни одна другая команда не выполняет финализацию автоматически.

## Зависимости

Читает:

- `memory-bank/tasks.md` — task_id, название, даты, описание, уровень сложности
- `memory-bank/backlog.md` — исходное описание задачи (если задача оттуда)
- `memory-bank/completed-tasks/_template.md` — шаблон записи

Ищет артефакты по task_id:

- `memory-bank/archive/` — файл `archive-[task_id].md` или `*[task_id]*.md`
- `memory-bank/reflection/` — файл `reflection-[task_id].md`

Создаёт:

- `memory-bank/completed-tasks/YYYY/MM/[task_id]_YYYY-MM-DD.md`

Обновляет:

- `memory-bank/backlog.md` — удалить задачу из активных
- `memory-bank/tasks.md` — очистить и подготовить к следующей задаче
- `memory-bank/activeContext.md` — сброс для следующей задачи
- `memory-bank/progress.md` — зафиксировать завершение задачи

## Алгоритм

1. **Прочитать `memory-bank/tasks.md`**
   - Извлечь: task_id, название, дату создания, дату завершения (текущая дата если не указана), уровень сложности, тип задачи
   - Если tasks.md пуст или не содержит задачи — сообщить "Нет активной задачи для финализации" и завершить

2. **Найти артефакты по task_id**
   - Искать `memory-bank/archive/archive-[task_id].md` и `memory-bank/archive/*[task_id]*.md`
   - Искать `memory-bank/reflection/reflection-[task_id].md`
   - Запомнить относительные пути найденных файлов (от корня `memory-bank/`)

3. **Собрать описание задачи**
   - Из `memory-bank/backlog.md` — исходное описание задачи (если есть)
   - Из `memory-bank/tasks.md` — раздел "Результат" или итоги из чеклиста
   - Сформировать секции для completed-записи:
     - **## Задание** — исходное задание (из backlog.md как было при постановке)
     - **## Изменения в задании** — добавить, если в процессе задание менялось; описать отличия от исходного (что изменилось и почему)
     - **## Результат** — ключевые итоги

   **Структура секций completed-записи:**
   - `## Задание` — всегда; исходное описание из backlog
   - `## Изменения в задании` — только при изменении задания; список отличий от исходного
   - `## Результат` — всегда; итоги выполнения

4. **Определить путь файла**
   - YYYY/MM — по дате **создания** задачи
   - Имя файла: `[task_id]_YYYY-MM-DD.md` — дата **завершения**
   - Создать подкаталоги YYYY/MM если не существуют

5. **Показать план и запросить подтверждение**
   - Показать: путь создаваемого файла, содержимое записи, что будет удалено/очищено
   - Дождаться явного подтверждения пользователя

6. **После подтверждения — создать completed-запись и обновить backlog:**
   - Создать файл `memory-bank/completed-tasks/YYYY/MM/[task_id]_YYYY-MM-DD.md` по шаблону `_template.md`
   - Удалить задачу из `memory-bank/backlog.md` (из раздела активных задач)

7. **Подготовить Memory Bank к следующей задаче:**

   **КРИТИЧНО:** Этот шаг сигнализирует, что текущая задача полностью завершена. AI обязан привести Memory Bank в состояние готовности к новой задаче.
   - **`memory-bank/tasks.md`:**
     - Перенести текущую задачу из "Current Task" в "Last Completed Task" (краткая запись: task_id, название, дата, статус COMPLETED, ссылка на completed-запись)
     - Секцию "Current Task" очистить — оставить только заголовок и плейсхолдер "Нет активной задачи"
     - Удалить все чеклисты, планы, файлы для изменения текущей задачи

   - **`memory-bank/activeContext.md`:**
     - Секцию "Current Focus" установить в "Нет активной задачи. Запустить `/van` для инициализации."
     - Секцию "Current Mode" установить в "IDLE — ожидание новой задачи"
     - Секцию "Next Steps" установить в "Запустить `/van [описание задачи]` для начала новой задачи"
     - Секцию "Context for AI" — очистить или обновить только общую информацию о проекте (стек, структура)

   - **`memory-bank/progress.md`:**
     - Добавить запись о завершённой задаче: `## [Дата]: [task_id] — ЗАВЕРШЕНО` с кратким итогом и ссылкой на completed-запись
     - Не очищать историю — progress.md накапливает записи

8. **Верификация**
   - Проверить что completed-файл создан по правильному пути
   - Проверить что задача удалена из backlog
   - Проверить что tasks.md готов к новой задаче (Current Task пуст)
   - Проверить что activeContext.md указывает на ожидание `/van`
   - Вывести итог: путь к созданному файлу, статус всех операций, сообщение "Memory Bank готов к следующей задаче. Запустите /van для начала."

## Интеграция с workflow

При инициализации задачи командой `/van` в чеклист `memory-bank/tasks.md` обязательно добавляется финальный пункт:

```
- [ ] CLOSE: Финализировать задачу командой /close-task
```

Этот пункт также упоминается в `memory-bank/activeContext.md` → "Next Steps" и в `memory-bank/progress.md`.

## Usage

Пользователь вводит `/close-task` после завершения всех фаз задачи.

## Пример

```
Пользователь: /close-task

Ассистент: "Финализация задачи context-api-todo-001:

Будет создано:
- memory-bank/completed-tasks/2026/01/context-api-todo-001_2026-02-02.md

Найдены артефакты:
- Архив: memory-bank/archive/archive-context-api-todo-001.md
- Рефлексия: memory-bank/reflection/reflection-context-api-todo-001.md

Будет обновлено:
- memory-bank/backlog.md — задача удалена из активных
- memory-bank/tasks.md — очищен, готов к новой задаче
- memory-bank/activeContext.md — сброшен в IDLE
- memory-bank/progress.md — добавлена запись о завершении

Выполнить?"
```
