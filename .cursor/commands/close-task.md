# close-task — Финализация задачи

**Назначение:** При вызове `/close-task` выполни следующий алгоритм. Создай completed-запись, удали задачу из backlog (если была), приведи Memory Bank в состояние готовности к следующей задаче.

**Источник task_id:** Секция "Current Task" (приоритет 1) или "Last Completed Task" (приоритет 2, если Current пуст или плейсхолдер).

---

## Алгоритм

### Шаг 1. Определить задачу

1. Прочитай `memory-bank/tasks.md`.
2. Извлеки task_id из "Current Task" или "Last Completed Task".
3. Если task_id не найден — сообщи "Нет активной задачи для финализации" и заверши.
4. Проверь: существует ли `memory-bank/completed-tasks/**/[task_id]*.md`?
   - Если да — сообщи "Задача [task_id] уже финализирована" и заверши.
5. Извлеки: task_id, название, дату создания, дату завершения (текущая дата если нет), уровень сложности, тип.

### Шаг 2. Найти артефакты

- Ищи `memory-bank/archive/archive-[task_id].md` и `memory-bank/archive/*[task_id]*.md`.
- Ищи `memory-bank/reflection/reflection-[task_id].md`.
- Запомни пути (относительно `memory-bank/`).
- **Наличие артефактов** определяет статус в Last Completed Task (см. Шаг 7).

### Шаг 3. Собрать описание для completed-записи

- **## Задание:** backlog → tasks/рефлексия/архив. Если не удалось — «Задание не удалось восстановить из доступных источников».
- **## Изменения в задании:** только при изменении задания в процессе.
- **## Результат:** итоги из tasks.md, рефлексии или архива.

### Шаг 4. Определить путь файла

- YYYY/MM — по дате **создания** задачи.
- Имя: `[task_id]_YYYY-MM-DD.md` — дата **завершения**.
- Создай подкаталоги YYYY/MM при необходимости.

### Шаг 5. Показать план и запросить подтверждение

Покажи: путь создаваемого файла, содержимое записи, что будет удалено/очищено. Дождись явного подтверждения пользователя.

### Шаг 6. После подтверждения — создать completed-запись и обновить backlog

1. Создай `memory-bank/completed-tasks/YYYY/MM/[task_id]_YYYY-MM-DD.md` по шаблону `_template.md`.
2. Заполни **## Ссылки:** архив, рефлексия, ветка, коммит (если доступны).
3. Если задача была в backlog — удали её из `memory-bank/backlog.md`.
4. **Разделы backlog** — разные правила по уровню заголовка:
   - **## (раздел):** не удалять. Если после удаления задачи в разделе не осталось задач — оставить заголовок и добавить плейсхолдер `(Нет активных задач)`.
   - **###, #### и глубже (подразделы):** если после удаления в подразделе не осталось задач — удалить подраздел целиком.

### Шаг 7. Подготовить Memory Bank

**Режим A** — задача из "Current Task":

- Перенеси задачу в "Last Completed Task" (task_id, название, дата, статус, ссылка на completed-запись).
- **Статус:** `COMPLETED & ARCHIVED` — только если существуют **оба** артефакта (архив и рефлексия). Иначе — `COMPLETED`.
- Удали секцию "Previous Completed Task" и любые другие секции со старыми завершёнными задачами.
- Очисти "Current Task": только заголовок и плейсхолдер "Нет активной задачи. Запустить `/van [описание задачи]` для начала новой задачи."
- Удали все чеклисты, планы, файлы для изменения текущей задачи.

**Режим B** — задача из "Last Completed Task":

- Добавь в "Last Completed Task" ссылку `**Completed:** [путь]`, если её нет.
- Удали секцию "Previous Completed Task" и любые другие секции со старыми завершёнными задачами.

**Общее для обоих режимов:**

- **activeContext.md:** Current Focus = "Нет активной задачи. Запустить `/van` для инициализации."; Current Mode = "IDLE — ожидание новой задачи"; Next Steps = "Запустить `/van [описание задачи]` для начала новой задачи"; Context for AI — только общая информация о проекте.
- **progress.md:** Добавь или обнови запись `## [Дата]: [task_id] — ЗАВЕРШЕНО` с итогом и ссылкой на completed-запись. **Удали все старые записи о завершённых задачах** — оставь только одну последнюю.

### Шаг 8. Верификация и итог

Проверь: completed-файл создан; задача удалена из backlog (если была); tasks.md — только одна Last Completed Task; activeContext — ожидание `/van`. Выведи итог и сообщение "Memory Bank готов к следующей задаче. Запустите /van для начала."

---

## Не делать

- **tasks.md:** Не оставлять секции "Previous Completed Task" или другие старые завершённые задачи. Только одна Last Completed Task.
- **tasks.md (Last Completed Task):** Не использовать "COMPLETED & ARCHIVED", если нет архива или рефлексии. Только "COMPLETED".
- **progress.md:** Не оставлять старые записи о завершённых задачах. Только одна последняя.
- **backlog.md:** Не удалять разделы `##`. Пустые разделы `##` — оставлять с плейсхолдером `(Нет активных задач)`. Пустые подразделы `###`, `####` и глубже — удалять целиком.

---

## Чек-лист выполнения

- [ ] task_id определён (Current или Last Completed)
- [ ] completed-запись не существует
- [ ] Артефакты (архив, рефлексия) найдены; статус выбран по наличию артефактов
- [ ] План показан, подтверждение получено
- [ ] Файл `completed-tasks/YYYY/MM/[task_id]_YYYY-MM-DD.md` создан
- [ ] Задача удалена из backlog (если была)
- [ ] backlog: пустые ## — с плейсхолдером; пустые ###/#### — удалены
- [ ] tasks.md: только Last Completed Task, без Previous/старых
- [ ] progress.md: только одна последняя завершённая задача
- [ ] activeContext.md: IDLE, ожидание /van
- [ ] Итог выведен пользователю
