# git-commit

## Назначение

Генерирует сообщение коммита на основе проанализированных staged-файлов по правилам из `docs/git-commit-description.md` (указатель — `.cursor/rules/git.mdc`).

## Алгоритм

1. Выполнить `git status` и убедиться, что есть staged файлы. Если нет — попросить добавить через `git add`.
2. Изучить изменения командой `git diff --staged`, чтобы понять что и зачем изменено. Если diff пуст — вывести «Нет файлов, добавленных для коммита.» и завершить. Один коммит — одна логическая задача; крупные изменения дробить.
3. Сформировать сообщение по правилам из `docs/git-commit-description.md`.
4. Сообщение выводить в кодовом блоке для удобного копирования пользователем; итоговый текст коммита сохранять без обрамляющих ```.
5. После вывода сообщения запросить подтверждение у пользователя для выполнения коммита. Предложить выполнить коммит с сгенерированным сообщением. Если пользователь подтверждает (через кнопку подтверждения или текстовое подтверждение типа "да", "ок", "выполни", "commit" и т.п.), выполнить коммит следующим образом:
   - Сохранить сгенерированное сообщение (без обрамляющих ```) во временный файл в корне проекта. **Имя файла:** см. секцию "Конфигурация" в `docs/common/git-commit-description.md`(по умолчанию:`.git-commit-msg.txt`). Кодировка: UTF-8 без BOM.
   - **КРИТИЧНО для Windows:** Использовать инструмент `Write` для создания файла, так как он гарантирует правильную UTF-8 кодировку без BOM. PowerShell команды (`Out-File`, `[System.IO.File]::WriteAllText`) имеют проблемы с кодировкой кириллицы в Windows.
   - Выполнить команду `git commit -F .git-commit-msg.txt` (использовать Shell с `required_permissions: ["all"]`)
   - Удалить временный файл после выполнения коммита (использовать Shell с `Remove-Item .git-commit-msg.txt`)
     Если пользователь отказывается или не подтверждает — завершить выполнение команды без создания коммита.
6. После выполнения коммита проверить результат:
   - Вывести последнее сообщение коммита командой `git log -1 --pretty=format:"%s%n%n%b"` для проверки корректности отображения
   - Если сообщение отображается некорректно (кракозябры, нечитаемые символы вместо кириллицы), предложить пользователю исправить кодировку
   - При подтверждении исправления:
     - Повторно сохранить исходное сообщение (без обрамляющих ```) во временный файл с кодировкой UTF-8 без BOM (используя инструмент `Write`, как в шаге 5)
     - Выполнить `git commit --amend -F .git-commit-msg.txt` для перезаписи сообщения коммита с правильной кодировкой (Shell с `required_permissions: ["all"]`)
     - Удалить временный файл после исправления (Shell с `Remove-Item .git-commit-msg.txt`)
     - Проверить корректность: выполнить `git log -1 --format=%B` и убедиться, что кириллица отображается правильно
     - Вывести подтверждение об успешном исправлении

## Формат сообщения

См. правила в `docs/git-commit-description.md`.
