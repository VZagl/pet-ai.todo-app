# git-commit

## Назначение

Генерирует сообщение коммита на основе проанализированных staged-файлов по правилам из `docs/git-commit-description.md` (указатель — `.cursor/rules/git.mdc`).

## Алгоритм

1. Выполнить `git status` и убедиться, что есть staged файлы. Если нет — попросить добавить через `git add`.
2. Изучить изменения командой `git diff --staged`, чтобы понять что и зачем изменено. Если diff пуст — вывести «Нет файлов, добавленных для коммита.» и завершить. Один коммит — одна логическая задача; крупные изменения дробить.
3. Сформировать сообщение по правилам из `docs/git-commit-description.md`.
4. Сообщение выводить в кодовом блоке для удобного копирования пользователем; итоговый текст коммита сохранять без обрамляющих ```.
5. После вывода сообщения запросить подтверждение у пользователя для выполнения коммита. Предложить выполнить коммит с сгенерированным сообщением. Если пользователь подтверждает (через кнопку подтверждения или текстовое подтверждение типа "да", "ок", "выполни", "commit" и т.п.), выполнить коммит следующим образом:
   - Сохранить сгенерированное сообщение (без обрамляющих ```) во временный файл в корне проекта (например, `commit_msg.txt`) с кодировкой UTF-8 без BOM. **Важно:** в Windows PowerShell стандартные команды (например, `Out-File -Encoding UTF8`) добавляют BOM, что может вызвать проблемы; необходимо использовать способ создания файла, который гарантирует UTF-8 без BOM (например, через инструмент `write`или`[System.IO.File]::WriteAllText`с`UTF8Encoding($false)` в PowerShell)
   - Выполнить команду `git commit -F commit_msg.txt` для корректной обработки кириллицы во всех ОС (в Windows PowerShell параметр `-m` может некорректно обрабатывать кодировку, использование файла гарантирует правильную работу везде)
   - Удалить временный файл после выполнения коммита
     Если пользователь отказывается или не подтверждает — завершить выполнение команды без создания коммита.
6. После выполнения коммита проверить результат:
   - Вывести последнее сообщение коммита командой `git log -1 --pretty=format:"%s%n%n%b"` для проверки корректности отображения
   - Если сообщение отображается некорректно (кракозябры, нечитаемые символы вместо кириллицы), предложить пользователю исправить кодировку
   - При подтверждении исправления:
     - Повторно сохранить исходное сообщение (без обрамляющих ```) во временный файл с кодировкой UTF-8 без BOM (используя тот же метод, что и в шаге 5)
     - Выполнить `git commit --amend -F commit_msg.txt` для перезаписи сообщения коммита с правильной кодировкой
     - Удалить временный файл после исправления
     - Вывести подтверждение об успешном исправлении

## Формат сообщения

См. правила в `docs/git-commit-description.md`.
