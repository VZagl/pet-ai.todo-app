# git-merge-to-develop

## Назначение

Выполняет merge текущей feature-ветки в ветку `develop` с использованием `--no-ff` и правильным сообщением merge-коммита в формате Conventional Commits. Перед выполнением генерирует и показывает описание merge-коммита, которое будет использовано для merge, и запрашивает подтверждение.

## Алгоритм

1. **Проверить текущую ветку**:
   - Выполнить `git branch --show-current` для определения текущей ветки
   - Если текущая ветка — `develop` или `main`, вывести ошибку: "Нельзя выполнить merge из ветки develop/main. Переключитесь на feature-ветку." и завершить выполнение
   - Если текущая ветка не существует или не определена, вывести ошибку и завершить выполнение

2. **Проверить наличие ветки develop**:
   - Выполнить `git branch -a | grep -E 'develop|origin/develop'` (или эквивалент для Windows PowerShell: `git branch -a | Select-String 'develop'`)
   - Если ветка `develop` не найдена, вывести предупреждение: "Ветка develop не найдена. Используется main как базовая ветка." и использовать `main` вместо `develop`

3. **Обновить локальную ветку develop**:
   - Выполнить `git fetch origin` для получения последних изменений
   - Выполнить `git checkout develop` (или `main`, если develop не существует)
   - Выполнить `git pull origin develop` (или `git pull origin main`) для обновления локальной ветки
   - Вернуться на исходную ветку: `git checkout <исходная_ветка>`

4. **Определить тип изменения для merge-коммита**:
   - Выполнить `git log <текущая_ветка> --oneline` для просмотра всех коммитов ветки
   - Выполнить `git diff develop..<текущая_ветка> --stat` (или `git diff main..<текущая_ветка> --stat`) для просмотра изменённых файлов
   - Проанализировать коммиты и изменённые файлы, определить основной тип изменения (fix, feat, refactor, chore и т.д.)
   - Определить scope на основе изменённых файлов или функциональной области

5. **Сформировать сообщение merge-коммита**:
   - Создать заголовок в формате Conventional Commits: `type(scope): описание`
   - В теле перечислить основные изменения из всех коммитов ветки (маркированный список)
   - Следовать правилам из `docs/common/git-commit-description.md`
   - Сообщение должно отражать суть всех изменений в feature-ветке
   - **Важно**: В сообщении merge-коммита описывать только изменения в коде проекта (исходный код, тесты, конфигурация и т.д.), без упоминания рабочих файлов memory-bank (activeContext.md, tasks.md, progress.md и т.д.), которые использовались в процессе решения задачи

6. **Показать сгенерированное сообщение merge-коммита и запросить подтверждение**:
   - Вывести информацию о текущей ветке и целевой ветке (develop или main)
   - Показать полное сгенерированное сообщение merge-коммита в виде блока кода для удобного просмотра
   - Явно спросить подтверждение (например: "Выполнить merge ветки <текущая_ветка> в develop с этим сообщением?", "Продолжить?")
   - Дождаться явного ответа пользователя (да/нет/ок/выполни и т.п.)
   - Если пользователь указывает на необходимость изменений в сообщении:
     - Внести изменения в описание
     - Показать обновлённое описание в виде блока кода
     - Снова спросить подтверждение
     - Повторять до получения подтверждения
   - Если пользователь отказывается или не подтверждает — завершить выполнение команды без выполнения merge

7. **Выполнить merge** (только после подтверждения):
   - Убедиться, что находимся на ветке `develop` (или `main`): `git checkout develop`
   - Создать файл `.git-commit-msg.txt` в корне проекта с полным текстом сообщения merge-коммита в кодировке **UTF-8 без BOM**
     - В Windows PowerShell использовать: `[System.IO.File]::WriteAllText('.git-commit-msg.txt', $content, [System.Text.UTF8Encoding]::new($false))`
     - Или использовать инструмент `write` с правильной кодировкой
   - Выполнить команду: `git merge --no-ff <текущая_ветка> -F .git-commit-msg.txt`
   - Удалить временный файл `.git-commit-msg.txt` после успешного merge

8. **Проверить результат**:
   - Вывести последнее сообщение merge-коммита командой `git log -1 --pretty=format:"%s%n%n%b"` для проверки корректности отображения
   - Если сообщение отображается некорректно (кракозябры, нечитаемые символы вместо кириллицы), предложить пользователю исправить кодировку
   - При подтверждении исправления:
     - Повторно сохранить исходное сообщение (без обрамляющих ```) во временный файл с кодировкой UTF-8 без BOM
     - Выполнить `git commit --amend -F .git-commit-msg.txt` для перезаписи сообщения merge-коммита с правильной кодировкой
     - Удалить временный файл после исправления
     - Вывести подтверждение об успешном исправлении

## Формат сообщения merge-коммита

См. правила в `docs/common/git-commit-description.md`. Сообщение должно быть в формате Conventional Commits с типом, соответствующим основному изменению в feature-ветке.

**Важно**: В сообщении merge-коммита описывать только изменения в коде проекта (исходный код, тесты, конфигурация и т.д.), без упоминания рабочих файлов memory-bank (activeContext.md, tasks.md, progress.md и т.д.), которые использовались в процессе решения задачи.

## Важные замечания

- **Кодировка**: Файл `.git-commit-msg.txt` должен быть в кодировке UTF-8 без BOM для корректной обработки кириллицы во всех ОС
- **Force push**: После merge можно безопасно удалить временную feature-ветку, так как вся история сохранится в merge-коммите
- **Конфликты**: Если возникнут конфликты при merge, их необходимо разрешить вручную перед завершением команды
