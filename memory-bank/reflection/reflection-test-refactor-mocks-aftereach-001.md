# Рефлексия: Рефакторинг тестов - использование afterEach для очистки моков

**Task ID:** test-refactor-mocks-aftereach-001  
**Complexity Level:** Level 1 - Quick Fix  
**Дата завершения:** 2026-01-26  
**Статус:** ✅ COMPLETED

## Краткое резюме

Выполнен рефакторинг тестов для автоматизации очистки моков через `afterEach` hook вместо ручных вызовов `mockRestore()`. Изменения внесены в два тестовых файла, все тесты проходят успешно.

## Проблема

В текущих тестах использовался ручной вызов `spy.mockRestore()` после каждого теста с моками. Если тест падал до вызова `mockRestore()`, мок оставался активным и мог влиять на другие тесты, создавая side effects между тестами.

## Решение

Добавлен глобальный `afterEach(() => { vi.restoreAllMocks(); })` hook в оба тестовых файла:

- `src/utils/storage.test.ts` - добавлен `afterEach`, удалён ручной `spy.mockRestore()`
- `src/components/TodoList/TodoList.test.tsx` - добавлен `afterEach`, удалён ручной `consoleErrorSpy.mockRestore()`

## Что сработало хорошо

1. **Простота реализации** - изменения были минимальными и понятными
2. **Немедленная польза** - автоматическая очистка моков повышает надёжность тестов
3. **Соответствие best practices** - использование `afterEach` для очистки является стандартной практикой в Vitest
4. **Отсутствие регрессий** - все существующие тесты продолжают работать корректно

## Вызовы

**Вызов 1:** Определение правильного метода очистки моков  
**Решение:** Использован `vi.restoreAllMocks()` вместо `vi.clearAllMocks()`, так как `restoreAllMocks()` восстанавливает оригинальные реализации методов, созданных через `spyOn()`, что критично для предотвращения утечек моков.

**Вызов 2:** Убедиться, что изменения не сломают существующие тесты  
**Решение:** Все тесты были запущены после изменений, все 12 тестов в изменённых файлах проходят успешно.

## Уроки

1. **Автоматическая очистка лучше ручной** - `afterEach` гарантирует очистку даже при падении теста, что повышает надёжность
2. **Разница между `restoreAllMocks()` и `clearAllMocks()`** - важно понимать, что `restoreAllMocks()` восстанавливает оригинальные реализации, а `clearAllMocks()` только очищает историю вызовов
3. **Профилактика лучше лечения** - лучше автоматизировать очистку моков, чем полагаться на ручные вызовы

## Технические детали

### Изменённые файлы

- `src/utils/storage.test.ts`
  - Добавлен импорт `afterEach`
  - Добавлен hook `afterEach(() => { vi.restoreAllMocks(); })`
  - Удалён ручной вызов `spy.mockRestore()` (строка 42)

- `src/components/TodoList/TodoList.test.tsx`
  - Добавлен импорт `afterEach`
  - Добавлен hook `afterEach(() => { vi.restoreAllMocks(); })`
  - Удалён ручной вызов `consoleErrorSpy.mockRestore()` (строка 88)

### Результаты тестирования

- ✅ `src/utils/storage.test.ts`: 7/7 тестов прошли успешно
- ✅ `src/components/TodoList/TodoList.test.tsx`: 5/5 тестов прошли успешно
- ✅ Всего: 12/12 тестов в изменённых файлах проходят успешно
- ✅ Моки автоматически очищаются после каждого теста
- ✅ Нет side effects между тестами

## Соответствие требованиям

### Функциональные требования

- ✅ **FR-01**: Добавлен `afterEach(() => { vi.restoreAllMocks(); })` в `src/utils/storage.test.ts`
- ✅ **FR-02**: Добавлен `afterEach(() => { vi.restoreAllMocks(); })` в `src/components/TodoList/TodoList.test.tsx`
- ✅ **FR-03**: Удалён ручной вызов `spy.mockRestore()` из `src/utils/storage.test.ts`
- ✅ **FR-04**: Удалён ручной вызов `consoleErrorSpy.mockRestore()` из `src/components/TodoList/TodoList.test.tsx`

### Нефункциональные требования

- ✅ **NFR-01**: Повышение надёжности тестов - автоматическая очистка моков даже при падении теста
- ✅ **NFR-02**: Все существующие тесты проходят успешно (12/12)
- ✅ **NFR-03**: Предотвращение side effects между тестами

## Следующие шаги

1. ✅ Рефлексия завершена
2. → Переход к архивированию задачи (ARCHIVE mode)

## Метрики

- **Время выполнения:** ~15 минут (быстрый рефакторинг)
- **Файлов изменено:** 2
- **Тестов:** 12/12 успешно (100%)
- **Регрессий:** 0
- **Соответствие требованиям:** 100%
