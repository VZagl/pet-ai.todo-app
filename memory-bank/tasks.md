# Memory Bank: Tasks

## Current Task

**Task ID:** edit-task-001  
**Название:** Редактирование текста задачи  
**Ветка:** `feat/inline-edit-todo-item`  
**Уровень:** Level 2 — Simple Enhancement  
**Источник:** backlog.md (Feature Enhancements)

**Требования:**

- Inline редактирование: **единственный способ** — кнопка редактирования (слева от кнопки удаления)
- Валидация при редактировании
- Явная кнопка «Отмена» + Escape на клавиатуре
- В режиме редактирования: скрыть кнопки редактирования и удаления, показать «Сохранить» (✓) и «Отмена» (×) в виде изображений
- После выхода: кнопки редактирования и удаления не «появляются», а меняют `disabled` с задержкой — чтобы интерфейс не сдвигался от появления ранее скрытых элементов
- Кнопки подтверждения/отмены: иконки (галочка, крестик), фон — `$color-success` и `$color-primary` соответственно
- Задержка перед повторным показом кнопок после выхода из режима редактирования
- **Связано с:** todo-app-001

**Статус:** Реализация завершена (BUILD) → Рефлексия завершена (REFLECT)

**Следующий шаг:** `/archive` для архивации

**Reflection Highlights:**

- **Что сработало:** План из 10 шагов, подход disabled вместо show/hide (без layout shift), рефакторинг кнопок — базовый класс `todo-item__btn` с модификаторами `--save`, `--cancel`, `--edit`, `--delete`, edit-wrapper с flex: 1 0 auto
- **Сложности:** Layout shift, input сжимается до 0, BEM-модификатор
- **Выводы:** disabled + задержка — предпочтительный паттерн; flex: 1 0 auto для input-wrapper; post-implementation refinements в tasks.md
- **Рефлексия:** [`memory-bank/reflection/reflection-edit-task-001.md`](reflection/reflection-edit-task-001.md)

---

## Description

Inline-редактирование текста задачи в компоненте TodoItem. **Единственный способ** входа в режим редактирования — кнопка редактирования (иконка карандаша) слева от кнопки удаления. Одиночный клик **только по чекбоксу** переключает выполнено/невыполнено (текст не кликабелен для toggle). В режиме редактирования: input вместо span, кнопки «Сохранить» (✓) и «Отмена» (×) в виде изображений — фон `$color-success` и `$color-primary` соответственно. Сохранение: Enter или кнопка «Сохранить». Отмена: Escape или кнопка «Отмена». После выхода из режима редактирования кнопки редактирования и удаления остаются в разметке, но `disabled`; через 400 ms становятся активными (без layout shift). Валидация по тем же правилам, что и в TodoInput.

## Complexity

- **Level:** 2
- **Type:** Simple Enhancement

## Technology Stack

- **Framework:** React 19
- **Build Tool:** Vite 7
- **Language:** TypeScript 5.9
- **Стили:** SCSS (sass-embedded)
- **i18n:** react-i18next

## Technology Validation Checkpoints

- [x] Проект инициализирован, стек подтверждён
- [x] Зависимости установлены (React, Testing Library, i18next)
- [x] Конфигурация сборки проверена
- [x] `updateTodo(id, text)` уже существует в useTodos/Context
- [x] Тестовый прогон проходит

## Status

- [x] Initialization complete
- [x] Planning complete
- [x] Technology validation complete
- [x] Implementation
- [x] Reflection complete
- [ ] Archiving

## Implementation Plan

### 1. Добавить состояние и логику редактирования в TodoItem

- [x] 1.1 Добавить `useState` для `isEditing` (boolean)
- [x] 1.2 Добавить `useState` для `editValue` (строка, текущий текст при редактировании)
- [x] 1.3 Добавить `useState` для `error` (строка, сообщение об ошибке валидации)
- [x] 1.4 Добавить `useState` для `actionButtonsEnabled` (boolean) — управляет `disabled` кнопок редактирования и удаления (через задержку после выхода из edit)
- [x] 1.5 Добавить `useRef` для input (автофокус при входе в режим редактирования)
- [x] 1.6 Деструктурировать `updateTodo` из `useTodoContext()`

### 2. Добавить кнопку редактирования (единственный способ входа в режим)

- [x] 2.1 Кнопка редактирования (иконка карандаша) слева от кнопки удаления
- [x] 2.2 `onClick` → `enterEditMode()`: `setIsEditing(true)`, `setEditValue(todo.text)`, `setError('')`, `setActionButtonsEnabled(false)`
- [x] 2.3 Порядок в режиме просмотра: [чекбокс] [текст] [кнопка редактирования] [кнопка удаления]

### 3. Условный рендер по `isEditing` (разные фрагменты)

- [x] 3.1 **Режим просмотра** (`!isEditing`): span с текстом + кнопка редактирования + кнопка удаления (всегда в разметке, `disabled={!actionButtonsEnabled}`)
- [x] 3.2 **Режим редактирования** (`isEditing`): input + кнопки «Сохранить» и «Отмена» (изображения)
- [x] 3.3 Кнопки редактирования и удаления: в режиме просмотра всегда рендерятся; при выходе из edit — `disabled` на 400 ms, затем `enabled` (без layout shift)
- [x] 3.4 `useEffect`: при `isEditing === true` → `inputRef.current?.focus()`, `select()`

### 4. Реализовать выход из режима и задержку кнопок

- [x] 4.1 Функция `exitEditMode()`: `setIsEditing(false)`, `setError('')`, `setActionButtonsEnabled(false)`; запустить `setTimeout` 400 ms → `setActionButtonsEnabled(true)` (кнопки остаются в DOM, меняется только `disabled`)
- [x] 4.2 При размонтировании: очистить таймер задержки (`clearTimeout`)
- [x] 4.3 Константа: `ACTION_BUTTONS_DELAY_MS = 400`

### 5. Реализовать сохранение и валидацию

- [x] 5.1 Функция `handleSave()`: trim, проверка пустой строки, проверка `MAX_TODO_LENGTH`
- [x] 5.2 При валидном вводе: `updateTodo(todo.id, trimmedValue)`, `exitEditMode()`
- [x] 5.3 При невалидном: `setError(...)`, не выходить из режима редактирования
- [x] 5.4 Вызов `handleSave` при `onKeyDown` (Enter) и клике по кнопке «Сохранить»
- [x] 5.5 Импорт `MAX_TODO_LENGTH` из `src/constants/todo`

### 6. Реализовать отмену (Escape + кнопка «Отмена»)

- [x] 6.1 Обработчик `onKeyDown`: при `e.key === 'Escape'` → `handleCancel()`, `e.stopPropagation()`
- [x] 6.2 Функция `handleCancel()`: `setEditValue(todo.text)`, `exitEditMode()`
- [x] 6.3 Кнопка «Отмена»: `onClick={handleCancel}`

### 7. Кнопки «Сохранить» и «Отмена» — изображения (иконки)

- [x] 7.1 Галочка (✓) для подтверждения: SVG или `<img>`, фон кнопки `$color-success` (#28a745)
- [x] 7.2 Крестик (×) для отмены: SVG или `<img>`, фон кнопки `$color-primary` (#3b82f6)
- [x] 7.3 Создать отдельные SVG-файлы в `src/assets/`: `check.svg`, `close.svg`, `edit.svg`
- [x] 7.4 Цвет иконок на кнопках: `$color-on-primary` (белый) для контраста

### 8. Добавить i18n

- [x] 8.1 Ключи в `ru/translation.json` (todoItem): `ariaEdit`, `ariaSave`, `ariaCancel`, `errorEmpty`, `errorMaxLength`
- [x] 8.2 Добавить в `en/translation.json` и `uk/translation.json`
- [x] 8.3 `aria-label` для кнопки редактирования, input, кнопок «Сохранить» и «Отмена»

### 9. Стили

- [x] 9.1 Стили для `todo-item__edit` (input): визуально как span, border при focus
- [x] 9.2 Стили для кнопок «Сохранить» и «Отмена»: размер, фон, hover
- [x] 9.3 Стили для кнопки редактирования (карандаш)
- [x] 9.4 Стили для состояния ошибки
- [x] 9.5 Следовать Style Guide (variables, transitions)

### 10. Тесты

- [x] 10.1 Тест: клик по кнопке редактирования переводит в режим редактирования
- [x] 10.1a Тест: двойной клик по тексту не переводит в режим редактирования
- [x] 10.1b Тест: двойной клик по кнопке «Сохранить» или «Отмена» не нажимает кнопку под ними (благодаря задержке disabled)
- [x] 10.2 Тест: Enter сохраняет изменения, вызывается updateTodo
- [x] 10.3 Тест: Escape отменяет редактирование без вызова updateTodo
- [x] 10.4 Тест: кнопка «Отмена» отменяет редактирование
- [x] 10.5 Тест: кнопка «Сохранить» сохраняет изменения
- [x] 10.6 Тест: пустая строка не сохраняется (валидация)
- [x] 10.7 Тест: кнопки редактирования и удаления disabled в режиме редактирования; после выхода остаются disabled 400 ms, затем enabled

## Creative Phases Required

- [ ] Не требуются (Level 2)

## Dependencies

- `useTodoContext` (updateTodo)
- `MAX_TODO_LENGTH` из `src/constants/todo`
- `useTranslation` (i18next)
- Существующая валидация TodoInput как референс

## Scroll при редактировании (вопрос 2)

**Ситуация:** при скролле списка форма редактирования сдвигается вместе с контентом.

**Распространённые подходы:**

| Подход                         | Описание                                                                                                                | Когда использовать                                                                                            |
| ------------------------------ | ----------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------- |
| **Inline в потоке (стандарт)** | Форма редактирования — часть строки, скроллится вместе со списком. PatternFly, Elastic UI, большинство todo-приложений. | Простое редактирование, короткие списки. Пользователь редко скроллит во время редактирования одного элемента. |
| **Модальное окно / Popover**   | При клике «Редактировать» открывается модалка или popover с фиксированной позицией. Список под ним можно скроллить.     | Сложные формы, много полей, длинные списки с частым скроллом во время редактирования.                         |
| **Блокировка скролла**         | Во время редактирования блокировать скролл контейнера.                                                                  | Редко; ухудшает UX.                                                                                           |
| **Авто-выход при скролле**     | При скролле автоматически сохранять или отменять.                                                                       | Может сбивать пользователя.                                                                                   |

**Рекомендация для pet.todo:** оставить **inline в потоке** — форма скроллится вместе со списком. Это стандартный паттерн для простого inline-редактирования. Если список длинный, пользователь обычно не скроллит во время правки одного элемента. При необходимости в будущем можно перейти на модальное окно.

## Challenges & Mitigations

| Вызов                                      | Митигация                                                                              |
| ------------------------------------------ | -------------------------------------------------------------------------------------- |
| Автофокус при входе в режим редактирования | `useRef` + `useEffect` при `isEditing`; `inputRef.current?.focus()` и `select()`       |
| Escape не должен закрывать модалки         | `e.stopPropagation()` в onKeyDown                                                      |
| Layout shift при выходе из edit            | Кнопки всегда в разметке; меняется только `disabled` с задержкой 400 ms (не show/hide) |
| Валидация как в TodoInput                  | Переиспользовать логику: trim, пустая строка, MAX_TODO_LENGTH                          |

## Post-implementation refinements

| Рефакторинг                                           | Решение                                                                                                                 |
| ----------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------- |
| Input сжимается до 0 при пустом тексте                | `edit-wrapper` с `flex: 1 0 auto`, `edit-actions` снаружи; input внутри с `width: 100%`, `box-sizing: border-box`       |
| BEM: модификатор на том элементе, который стилизуется | `todo-item__content--editing` на сам `__content`, а не на родителе. Модификатор на элементе, который визуально меняется |
| Дублирование стилей кнопок                            | Базовый класс `todo-item__btn` с общими стилями; модификаторы `--save`, `--cancel`, `--edit`, `--delete`                |
| Плохо видно активный элемент при редактировании       | `todo-item__content--editing` с `background-color: $color-bg-hover`, `border-radius`                                    |

## Константы

- `ACTION_BUTTONS_DELAY_MS = 400` — задержка перед показом кнопок редактирования и удаления после выхода из режима редактирования

## Affected Files

- `src/components/TodoItem/TodoItem.tsx` — основная логика, кнопка редактирования, кнопки Save/Cancel
- `src/components/TodoItem/TodoItem.scss` — стили для input, кнопок (в т.ч. $color-success, $color-primary)
- `src/components/TodoItem/TodoItem.test.tsx` — новые тесты
- `src/assets/` — SVG-иконки: check.svg (галочка), close.svg (крестик), edit.svg (карандаш)
- `src/locales/ru/translation.json` — ключи todoItem
- `src/locales/en/translation.json` — ключи todoItem
- `src/locales/uk/translation.json` — ключи todoItem

---

## Last Completed Task

**Task ID:** i18n-002  
**Название:** Украинская локализация (uk)  
**Дата:** 2026-02-16  
**Статус:** ✅ COMPLETED & ARCHIVED  
**Запись:** [`memory-bank/completed-tasks/2026/02/i18n-002_2026-02-16.md`](completed-tasks/2026/02/i18n-002_2026-02-16.md)  
**Архив:** [`memory-bank/archive/archive-i18n-002.md`](archive/archive-i18n-002.md)  
**Рефлексия:** [`memory-bank/reflection/reflection-i18n-002.md`](reflection/reflection-i18n-002.md)

**Следующий шаг:** `/van` для инициализации новой задачи.
